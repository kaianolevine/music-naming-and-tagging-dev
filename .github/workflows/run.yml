name: Music Tag and Rename
run-name: Music Tag and Rename (${{ github.event_name }})

on:
  workflow_dispatch:

concurrency:
  group: retag-rename
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 340

    env:
      GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
      LOGGING_LEVEL: ${{ vars.LOGGING_LEVEL }}
      ACOUSTID_API_KEY: ${{ secrets.ACOUSTID_API_KEY }}
      MUSIC_UPLOAD_SOURCE_FOLDER_ID: ${{ vars.MUSIC_UPLOAD_SOURCE_FOLDER_ID }}
      MUSIC_TAGGING_OUTPUT_FOLDER_ID: ${{ vars.MUSIC_TAGGING_OUTPUT_FOLDER_ID }}

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: üéß Install system deps (ffmpeg + chromaprint)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends ffmpeg libchromaprint-tools
          echo "ffmpeg: $(ffmpeg -version | head -n 1)"
          echo "fpcalc: $(fpcalc -version || true)"
          which ffmpeg
          which fpcalc

      - name: üì¶ Install Poetry
        run: pip install poetry

      - name: üß∞ Install dependencies
        run: poetry install --no-interaction

      - name: üèÉ Run music retagger
        run: poetry run python -m music_naming_and_tagging.main